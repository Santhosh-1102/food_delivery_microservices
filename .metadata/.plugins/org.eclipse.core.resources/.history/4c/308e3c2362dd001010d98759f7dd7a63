package com.order.Service.Implementation;

import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

import org.springframework.stereotype.Service;

import com.order.Client.RestaurentClient;
import com.order.Exception.MenuIsNotFoundException;
import com.order.Service.OrderService;
import com.order.dto.MenuItemResponse;
import com.order.dto.OrderDTO;
import com.order.dto.OrderItemRequest;
import com.order.dto.OrderRequest;
import com.order.dto.RestaurentDTO;
import com.order.model.Order;
import com.order.model.OrderStatus;
import com.order.repository.OrderRepo;

import lombok.RequiredArgsConstructor;

@Service
@RequiredArgsConstructor
public class OrderImplementation implements OrderService{

	private final RestaurentClient restaurentClient;
	
	private final OrderRepo orderRepo;
	

	@Override
	public RestaurentDTO validateRestaurant(Integer restaurantId) {
		return restaurentClient.getRestaurantById(restaurantId);
	}


	@Override
	public List<MenuItemResponse> getMenu(Integer restaurentId,OrderRequest request) {
		List<MenuItemResponse> orderMenu = restaurentClient.getMenu(restaurentId);
		
		Map<Integer, MenuItemResponse> menuMap=orderMenu.stream()
															.collect(Collectors
																	.toMap(MenuItemResponse::getId, 
																			item->item));
		
		double totalAmount=0;
		
		for(OrderItemRequest item:request.getItems()) {
			MenuItemResponse menuItem = menuMap.get(item.getMenuItemId());
			
			if(menuItem==null)
				throw new MenuIsNotFoundException("menu item is not available "+item.getMenuItemId());
			
			if(!menuItem.getAvailable())
			throw new MenuIsNotFoundException("Menu is out of Stock"+menuItem.getName());	
			
			totalAmount+=menuItem.getPrice()*item.getQuantity();
			
			Order order=new Order();
			order.setRestaurantId(restaurentId);
			order.setTotalAmount(totalAmount);
			order.setStatus(OrderStatus.CONFIRMED);
			
			Order saveOrder = orderRepo.save(order);
			 
			return mapToResponse(saveOrder);
			
			
		}
		
	}
	private OrderDTO mapToResponse(Order order) {
       return new OrderDTO(
    		   order.getOrederId(),
    		   order.getRestaurantId(),
    		   order.getTotalAmount(),
    		   order.getStatus()
    		);
    }
}
